CREATE DATABASE IF NOT EXISTS ideau_patrimonio;
USE ideau_patrimonio;

-- Tabela: papel
CREATE TABLE papel (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(50) NOT NULL UNIQUE COMMENT 'Nome do papel (master, admin, operador)'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: usuario
CREATE TABLE usuario (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(255) NOT NULL COMMENT 'Nome completo do usuário',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email do usuário, usado para login',
    senha_hash VARCHAR(255) NOT NULL COMMENT 'Hash da senha do usuário',
    ativo BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'Indica se o usuário está ativo',
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Data e hora de criação do registro',
    atualizado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Data e hora da última atualização do registro'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: usuario_papel (N:N entre usuario e papel)
CREATE TABLE usuario_papel (
    usuario_id INT NOT NULL COMMENT 'ID do usuário',
    papel_id INT NOT NULL COMMENT 'ID do papel',
    PRIMARY KEY (usuario_id, papel_id),
    FOREIGN KEY (usuario_id) REFERENCES usuario(id) ON DELETE CASCADE ON UPDATE CASCADE,
    FOREIGN KEY (papel_id) REFERENCES papel(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: fornecedor
CREATE TABLE fornecedor (
    id INT AUTO_INCREMENT PRIMARY KEY,
    razao_social VARCHAR(255) NOT NULL COMMENT 'Razão social do fornecedor',
    cnpj VARCHAR(18) NOT NULL UNIQUE COMMENT 'CNPJ do fornecedor',
    ie VARCHAR(20) COMMENT 'Inscrição Estadual do fornecedor',
    contato VARCHAR(255) COMMENT 'Nome do contato na empresa fornecedora',
    telefone VARCHAR(20) COMMENT 'Telefone do fornecedor',
    email VARCHAR(255) COMMENT 'Email do fornecedor'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: categoria
CREATE TABLE categoria (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL UNIQUE COMMENT 'Nome da categoria do bem (ex: Computadores, Mobiliário)',
    vida_util_meses INT COMMENT 'Vida útil esperada em meses para bens desta categoria',
    valor_residual_percent DECIMAL(5,2) COMMENT 'Percentual do valor residual para cálculo de depreciação'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: setor
CREATE TABLE setor (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL UNIQUE COMMENT 'Nome do setor ou departamento'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: local
CREATE TABLE local (
    id INT AUTO_INCREMENT PRIMARY KEY,
    setor_id INT NOT NULL COMMENT 'ID do setor ao qual o local pertence',
    predio VARCHAR(100) COMMENT 'Nome ou número do prédio',
    sala VARCHAR(100) COMMENT 'Número ou nome da sala',
    descricao VARCHAR(255) COMMENT 'Descrição detalhada do local',
    FOREIGN KEY (setor_id) REFERENCES setor(id) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: centro_custo
CREATE TABLE centro_custo (
    id INT AUTO_INCREMENT PRIMARY KEY,
    codigo VARCHAR(50) NOT NULL UNIQUE COMMENT 'Código único do centro de custo',
    nome VARCHAR(255) NOT NULL COMMENT 'Nome do centro de custo'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: nota_fiscal
CREATE TABLE nota_fiscal (
    id INT AUTO_INCREMENT PRIMARY KEY,
    numero VARCHAR(50) NOT NULL COMMENT 'Número da Nota Fiscal',
    serie VARCHAR(10) COMMENT 'Série da Nota Fiscal',
    chave_acesso VARCHAR(44) NOT NULL UNIQUE COMMENT 'Chave de acesso da Nota Fiscal Eletrônica',
    data_emissao DATE NOT NULL COMMENT 'Data de emissão da Nota Fiscal',
    fornecedor_id INT NOT NULL COMMENT 'ID do fornecedor da Nota Fiscal',
    valor_total DECIMAL(15,2) NOT NULL COMMENT 'Valor total da Nota Fiscal',
    FOREIGN KEY (fornecedor_id) REFERENCES fornecedor(id) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: nota_fiscal_item
CREATE TABLE nota_fiscal_item (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nota_fiscal_id INT NOT NULL COMMENT 'ID da Nota Fiscal a que o item pertence',
    descricao VARCHAR(255) NOT NULL COMMENT 'Descrição do item na Nota Fiscal',
    quantidade INT NOT NULL COMMENT 'Quantidade do item',
    valor_unitario DECIMAL(15,2) NOT NULL COMMENT 'Valor unitário do item',
    ncm VARCHAR(8) COMMENT 'NCM do item',
    cfop VARCHAR(4) COMMENT 'CFOP do item',
    FOREIGN KEY (nota_fiscal_id) REFERENCES nota_fiscal(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: patrimonio
CREATE TABLE patrimonio (
    id INT AUTO_INCREMENT PRIMARY KEY,
    codigo_tombamento VARCHAR(100) NOT NULL UNIQUE COMMENT 'Código único de tombamento do bem patrimonial',
    descricao TEXT NOT NULL COMMENT 'Descrição detalhada do bem',
    categoria_id INT NOT NULL COMMENT 'ID da categoria do bem',
    numero_serie VARCHAR(100) COMMENT 'Número de série do bem',
    data_aquisicao DATE NOT NULL COMMENT 'Data de aquisição do bem',
    valor_aquisicao DECIMAL(15,2) NOT NULL COMMENT 'Valor de aquisição do bem',
    nota_fiscal_item_id INT UNIQUE NULL COMMENT 'ID do item da nota fiscal que originou este bem (1:1 opcional)',
    centro_custo_id INT NOT NULL COMMENT 'ID do centro de custo ao qual o bem está alocado',
    setor_atual_id INT NOT NULL COMMENT 'ID do setor onde o bem está atualmente',
    local_atual_id INT NOT NULL COMMENT 'ID do local físico onde o bem está atualmente',
    status ENUM('ativo', 'em_manutencao', 'baixado', 'extraviado', 'emprestado', 'sucateado') NOT NULL DEFAULT 'ativo' COMMENT 'Status atual do bem',
    observacoes TEXT COMMENT 'Observações adicionais sobre o bem',
    FOREIGN KEY (categoria_id) REFERENCES categoria(id) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (nota_fiscal_item_id) REFERENCES nota_fiscal_item(id) ON DELETE SET NULL ON UPDATE CASCADE,
    FOREIGN KEY (centro_custo_id) REFERENCES centro_custo(id) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (setor_atual_id) REFERENCES setor(id) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (local_atual_id) REFERENCES local(id) ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_patrimonio_descricao (descricao(255)),
    INDEX idx_patrimonio_numero_serie (numero_serie),
    INDEX idx_patrimonio_codigo_tombamento (codigo_tombamento)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: movimentacao
CREATE TABLE movimentacao (
    id INT AUTO_INCREMENT PRIMARY KEY,
    patrimonio_id INT NOT NULL COMMENT 'ID do bem patrimonial movimentado',
    de_setor_id INT NULL COMMENT 'ID do setor de origem da movimentação (NULL se for entrada inicial)',
    de_local_id INT NULL COMMENT 'ID do local de origem da movimentação (NULL se for entrada inicial)',
    para_setor_id INT NOT NULL COMMENT 'ID do setor de destino da movimentação',
    para_local_id INT NOT NULL COMMENT 'ID do local de destino da movimentação',
    motivo TEXT COMMENT 'Motivo da movimentação',
    usuario_id INT NOT NULL COMMENT 'ID do usuário que realizou a movimentação',
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Data e hora da movimentação',
    FOREIGN KEY (patrimonio_id) REFERENCES patrimonio(id) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (de_setor_id) REFERENCES setor(id) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (de_local_id) REFERENCES local(id) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (para_setor_id) REFERENCES setor(id) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (para_local_id) REFERENCES local(id) ON DELETE RESTRICT ON UPDATE CASCADE,
    FOREIGN KEY (usuario_id) REFERENCES usuario(id) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: manutencao
CREATE TABLE manutencao (
    id INT AUTO_INCREMENT PRIMARY KEY,
    patrimonio_id INT NOT NULL COMMENT 'ID do bem patrimonial que sofreu manutenção',
    tipo ENUM('preventiva', 'corretiva') NOT NULL COMMENT 'Tipo de manutenção (preventiva ou corretiva)',
    descricao TEXT NOT NULL COMMENT 'Descrição da manutenção realizada',
    custo DECIMAL(15,2) COMMENT 'Custo total da manutenção',
    data_inicio DATE NOT NULL COMMENT 'Data de início da manutenção',
    data_fim DATE COMMENT 'Data de fim da manutenção',
    empresa VARCHAR(255) COMMENT 'Empresa responsável pela manutenção',
    nf_servico_id INT NULL COMMENT 'ID da nota fiscal de serviço, se houver',
    FOREIGN KEY (patrimonio_id) REFERENCES patrimonio(id) ON DELETE RESTRICT ON UPDATE CASCADE
    -- FOREIGN KEY (nf_servico_id) REFERENCES nota_fiscal_servico(id) ON DELETE SET NULL ON UPDATE CASCADE -- Assumindo que nota_fiscal_servico seria uma tabela separada, não especificada.
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: anexo_meta
CREATE TABLE anexo_meta (
    id INT AUTO_INCREMENT PRIMARY KEY,
    entidade ENUM('patrimonio', 'manutencao', 'nota_fiscal') NOT NULL COMMENT 'Entidade à qual o anexo está vinculado',
    entidade_id INT NOT NULL COMMENT 'ID da entidade à qual o anexo está vinculado',
    nome_arquivo VARCHAR(255) NOT NULL COMMENT 'Nome original do arquivo',
    caminho VARCHAR(255) NOT NULL COMMENT 'Caminho de armazenamento do arquivo (metadados, não o arquivo em si)',
    tamanho_bytes BIGINT COMMENT 'Tamanho do arquivo em bytes',
    mime_type VARCHAR(100) COMMENT 'Tipo MIME do arquivo',
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Data e hora de upload do anexo'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: depreciacao_lancamento
CREATE TABLE depreciacao_lancamento (
    id INT AUTO_INCREMENT PRIMARY KEY,
    patrimonio_id INT NOT NULL COMMENT 'ID do bem patrimonial depreciado',
    competencia DATE NOT NULL COMMENT 'Mês/Ano de competência do lançamento da depreciação',
    valor DECIMAL(15,2) NOT NULL COMMENT 'Valor da depreciação lançada no período',
    acumulado DECIMAL(15,2) NOT NULL COMMENT 'Valor acumulado da depreciação até o período',
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Data e hora do lançamento da depreciação',
    FOREIGN KEY (patrimonio_id) REFERENCES patrimonio(id) ON DELETE RESTRICT ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Tabela: auditoria
CREATE TABLE auditoria (
    id INT AUTO_INCREMENT PRIMARY KEY,
    tabela VARCHAR(100) NOT NULL COMMENT 'Nome da tabela auditada',
    registro_id INT NOT NULL COMMENT 'ID do registro afetado na tabela auditada',
    acao ENUM('INSERT', 'UPDATE', 'DELETE') NOT NULL COMMENT 'Tipo de ação (INSERT, UPDATE, DELETE)',
    antes_json JSON COMMENT 'Estado do registro ANTES da ação (para UPDATE/DELETE)',
    depois_json JSON COMMENT 'Estado do registro DEPOIS da ação (para INSERT/UPDATE)',
    usuario_id INT NULL COMMENT 'ID do usuário que realizou a ação (NULL para ações automáticas)',
    criado_em TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'Data e hora da ação auditada',
    FOREIGN KEY (usuario_id) REFERENCES usuario(id) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Índices adicionais para busca
CREATE INDEX idx_nota_fiscal_numero_chave ON nota_fiscal (numero, chave_acesso);
CREATE INDEX idx_fornecedor_cnpj_razao ON fornecedor (cnpj, razao_social);




-- Comentários sobre as regras/constraints:
-- Todas as colunas de valores monetários (custo, valor_total, valor_unitario, valor_aquisicao, valor, acumulado) são DECIMAL(15,2).
-- As chaves estrangeiras estão configuradas com ON UPDATE CASCADE e ON DELETE RESTRICT, exceto para `nota_fiscal_item_id` em `patrimonio` e `usuario_id` em `auditoria` que usam ON DELETE SET NULL, conforme solicitado.
-- Índices foram criados para campos de busca frequente como `patrimonio.descricao`, `patrimonio.numero_serie`, `patrimonio.codigo_tombamento`, `nota_fiscal.numero`, `nota_fiscal.chave_acesso`, `fornecedor.cnpj`, `fornecedor.razao_social`.
-- As colunas `UNIQUE` e `NOT NULL` foram aplicadas conforme especificado nos requisitos.
-- Os tipos ENUM foram utilizados para `patrimonio.status`, `movimentacao.tipo` e `anexo_meta.entidade`.




-- VISÕES (VIEWs) para segurança e papéis

-- VIEW para operadores: oculta informações sensíveis do usuário e detalhes internos
CREATE VIEW view_patrimonio_operador AS
SELECT
    p.id,
    p.codigo_tombamento,
    p.descricao,
    c.nome AS categoria_nome,
    p.numero_serie,
    p.data_aquisicao,
    p.valor_aquisicao,
    nfi.descricao AS item_nf_descricao,
    cc.nome AS centro_custo_nome,
    s.nome AS setor_atual_nome,
    l.descricao AS local_atual_descricao,
    p.status,
    p.observacoes
FROM
    patrimonio p
JOIN
    categoria c ON p.categoria_id = c.id
JOIN
    centro_custo cc ON p.centro_custo_id = cc.id
JOIN
    setor s ON p.setor_atual_id = s.id
JOIN
    local l ON p.local_atual_id = l.id
LEFT JOIN
    nota_fiscal_item nfi ON p.nota_fiscal_item_id = nfi.id;

-- VIEW para listar usuários e seus papéis (sem senha_hash)
CREATE VIEW view_usuarios_papeis AS
SELECT
    u.id AS usuario_id,
    u.nome AS usuario_nome,
    u.email AS usuario_email,
    u.ativo AS usuario_ativo,
    p.nome AS papel_nome
FROM
    usuario u
JOIN
    usuario_papel up ON u.id = up.usuario_id
JOIN
    papel p ON up.papel_id = p.id;




-- PROCEDUREs e FUNCTIONs

DELIMITER //

-- sp_criar_usuario: Insere um novo usuário com senha hash e atribui um papel.
-- Simula o hash da senha com SHA2+SALT, pois bcrypt/argon2 não são nativos do MySQL.
CREATE PROCEDURE sp_criar_usuario(
    IN p_nome VARCHAR(255),
    IN p_email VARCHAR(255),
    IN p_senha_plana VARCHAR(255),
    IN p_papel_nome VARCHAR(50)
)
BEGIN
    DECLARE v_senha_hash VARCHAR(255);
    DECLARE v_papel_id INT;
    DECLARE v_usuario_id INT;

    -- Simulação de hash de senha (SHA2 + SALT)
    SET v_senha_hash = SHA2(CONCAT(p_senha_plana, 'um_salt_secreto_e_longo'), 256);

    -- Obter o ID do papel
    SELECT id INTO v_papel_id FROM papel WHERE nome = p_papel_nome;

    -- Inserir o usuário
    INSERT INTO usuario (nome, email, senha_hash)
    VALUES (p_nome, p_email, v_senha_hash);

    SET v_usuario_id = LAST_INSERT_ID();

    -- Atribuir o papel ao usuário
    IF v_papel_id IS NOT NULL THEN
        INSERT INTO usuario_papel (usuario_id, papel_id)
        VALUES (v_usuario_id, v_papel_id);
    ELSE
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Papel não encontrado.';
    END IF;
END //

-- sp_registrar_patrimonio: Registra um novo patrimônio validando a unicidade do código de tombamento.
CREATE PROCEDURE sp_registrar_patrimonio(
    IN p_codigo_tombamento VARCHAR(100),
    IN p_descricao TEXT,
    IN p_categoria_id INT,
    IN p_numero_serie VARCHAR(100),
    IN p_data_aquisicao DATE,
    IN p_valor_aquisicao DECIMAL(15,2),
    IN p_nota_fiscal_item_id INT,
    IN p_centro_custo_id INT,
    IN p_setor_atual_id INT,
    IN p_local_atual_id INT,
    IN p_status ENUM('ativo', 'em_manutencao', 'baixado', 'extraviado', 'emprestado', 'sucateado'),
    IN p_observacoes TEXT
)
BEGIN
    -- Verifica se o código de tombamento já existe
    IF EXISTS (SELECT 1 FROM patrimonio WHERE codigo_tombamento = p_codigo_tombamento) THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Código de tombamento já existe.';
    ELSE
        INSERT INTO patrimonio (
            codigo_tombamento, descricao, categoria_id, numero_serie, data_aquisicao,
            valor_aquisicao, nota_fiscal_item_id, centro_custo_id, setor_atual_id,
            local_atual_id, status, observacoes
        )
        VALUES (
            p_codigo_tombamento, p_descricao, p_categoria_id, p_numero_serie, p_data_aquisicao,
            p_valor_aquisicao, p_nota_fiscal_item_id, p_centro_custo_id, p_setor_atual_id,
            p_local_atual_id, p_status, p_observacoes
        );
    END IF;
END //

-- sp_busca_patrimonio: Busca patrimônios com parâmetros opcionais.
CREATE PROCEDURE sp_busca_patrimonio(
    IN p_termo_busca VARCHAR(255),
    IN p_categoria_id INT,
    IN p_nota_fiscal_id INT,
    IN p_setor_id INT,
    IN p_status ENUM('ativo', 'em_manutencao', 'baixado', 'extraviado', 'emprestado', 'sucateado'),
    IN p_data_aquisicao_inicio DATE,
    IN p_data_aquisicao_fim DATE,
    IN p_fornecedor_id INT
)
BEGIN
    SELECT
        p.id,
        p.codigo_tombamento,
        p.descricao,
        c.nome AS categoria_nome,
        p.numero_serie,
        p.data_aquisicao,
        p.valor_aquisicao,
        nfi.descricao AS item_nf_descricao,
        cc.nome AS centro_custo_nome,
        s.nome AS setor_atual_nome,
        l.descricao AS local_atual_descricao,
        p.status,
        p.observacoes,
        nf.numero AS nota_fiscal_numero,
        f.razao_social AS fornecedor_razao_social
    FROM
        patrimonio p
    JOIN
        categoria c ON p.categoria_id = c.id
    JOIN
        centro_custo cc ON p.centro_custo_id = cc.id
    JOIN
        setor s ON p.setor_atual_id = s.id
    JOIN
        local l ON p.local_atual_id = l.id
    LEFT JOIN
        nota_fiscal_item nfi ON p.nota_fiscal_item_id = nfi.id
    LEFT JOIN
        nota_fiscal nf ON nfi.nota_fiscal_id = nf.id
    LEFT JOIN
        fornecedor f ON nf.fornecedor_id = f.id
    WHERE
        (p_termo_busca IS NULL OR
         p.codigo_tombamento LIKE CONCAT('%', p_termo_busca, '%') OR
         p.descricao LIKE CONCAT('%', p_termo_busca, '%') OR
         p.numero_serie LIKE CONCAT('%', p_termo_busca, '%') OR
         nf.numero LIKE CONCAT('%', p_termo_busca, '%') OR
         f.razao_social LIKE CONCAT('%', p_termo_busca, '%'))
        AND (p_categoria_id IS NULL OR p.categoria_id = p_categoria_id)
        AND (p_nota_fiscal_id IS NULL OR nf.id = p_nota_fiscal_id)
        AND (p_setor_id IS NULL OR p.setor_atual_id = p_setor_id)
        AND (p_status IS NULL OR p.status = p_status)
        AND (p_data_aquisicao_inicio IS NULL OR p.data_aquisicao >= p_data_aquisicao_inicio)
        AND (p_data_aquisicao_fim IS NULL OR p.data_aquisicao <= p_data_aquisicao_fim)
        AND (p_fornecedor_id IS NULL OR f.id = p_fornecedor_id);
END //

-- sp_transferir_patrimonio: Registra uma movimentação e atualiza o local atual do patrimônio.
CREATE PROCEDURE sp_transferir_patrimonio(
    IN p_patrimonio_id INT,
    IN p_para_setor_id INT,
    IN p_para_local_id INT,
    IN p_motivo TEXT,
    IN p_usuario_id INT
)
BEGIN
    DECLARE v_de_setor_id INT;
    DECLARE v_de_local_id INT;

    -- Obter o setor e local atuais do patrimônio
    SELECT setor_atual_id, local_atual_id
    INTO v_de_setor_id, v_de_local_id
    FROM patrimonio
    WHERE id = p_patrimonio_id;

    -- Inserir a movimentação
    INSERT INTO movimentacao (
        patrimonio_id, de_setor_id, de_local_id, para_setor_id, para_local_id, motivo, usuario_id
    )
    VALUES (
        p_patrimonio_id, v_de_setor_id, v_de_local_id, p_para_setor_id, p_para_local_id, p_motivo, p_usuario_id
    );

    -- O TRIGGER trg_movimentacao_after_insert cuidará da atualização de patrimonio.setor_atual_id/local_atual_id
END //

DELIMITER ;




-- TRIGGERs

DELIMITER //

-- trg_movimentacao_after_insert: Atualiza o setor e local atuais do patrimônio após uma movimentação.
CREATE TRIGGER trg_movimentacao_after_insert
AFTER INSERT ON movimentacao
FOR EACH ROW
BEGIN
    UPDATE patrimonio
    SET
        setor_atual_id = NEW.para_setor_id,
        local_atual_id = NEW.para_local_id
    WHERE
        id = NEW.patrimonio_id;
END //

-- TRIGGERs de auditoria genéricos

-- trg_auditoria_patrimonio_insert
CREATE TRIGGER trg_auditoria_patrimonio_insert
AFTER INSERT ON patrimonio
FOR EACH ROW
BEGIN
    INSERT INTO auditoria (tabela, registro_id, acao, antes_json, depois_json, usuario_id)
    VALUES (
        'patrimonio',
        NEW.id,
        'INSERT',
        NULL,
        JSON_OBJECT(
            'id', NEW.id,
            'codigo_tombamento', NEW.codigo_tombamento,
            'descricao', NEW.descricao,
            'categoria_id', NEW.categoria_id,
            'numero_serie', NEW.numero_serie,
            'data_aquisicao', NEW.data_aquisicao,
            'valor_aquisicao', NEW.valor_aquisicao,
            'nota_fiscal_item_id', NEW.nota_fiscal_item_id,
            'centro_custo_id', NEW.centro_custo_id,
            'setor_atual_id', NEW.setor_atual_id,
            'local_atual_id', NEW.local_atual_id,
            'status', NEW.status,
            'observacoes', NEW.observacoes
        ),
        -- Assumindo que o usuario_id pode ser obtido de uma variável de sessão ou contexto da aplicação
        -- Para fins de exemplo, usaremos um valor fixo ou NULL
        (SELECT id FROM usuario WHERE email = CURRENT_USER() LIMIT 1) -- Exemplo: tenta pegar o ID do usuário logado
    );
END //

-- trg_auditoria_patrimonio_update
CREATE TRIGGER trg_auditoria_patrimonio_update
AFTER UPDATE ON patrimonio
FOR EACH ROW
BEGIN
    INSERT INTO auditoria (tabela, registro_id, acao, antes_json, depois_json, usuario_id)
    VALUES (
        'patrimonio',
        NEW.id,
        'UPDATE',
        JSON_OBJECT(
            'id', OLD.id,
            'codigo_tombamento', OLD.codigo_tombamento,
            'descricao', OLD.descricao,
            'categoria_id', OLD.categoria_id,
            'numero_serie', OLD.numero_serie,
            'data_aquisicao', OLD.data_aquisicao,
            'valor_aquisicao', OLD.valor_aquisicao,
            'nota_fiscal_item_id', OLD.nota_fiscal_item_id,
            'centro_custo_id', OLD.centro_custo_id,
            'setor_atual_id', OLD.setor_atual_id,
            'local_atual_id', OLD.local_atual_id,
            'status', OLD.status,
            'observacoes', OLD.observacoes
        ),
        JSON_OBJECT(
            'id', NEW.id,
            'codigo_tombamento', NEW.codigo_tombamento,
            'descricao', NEW.descricao,
            'categoria_id', NEW.categoria_id,
            'numero_serie', NEW.numero_serie,
            'data_aquisicao', NEW.data_aquisicao,
            'valor_aquisicao', NEW.valor_aquisicao,
            'nota_fiscal_item_id', NEW.nota_fiscal_item_id,
            'centro_custo_id', NEW.centro_custo_id,
            'setor_atual_id', NEW.setor_atual_id,
            'local_atual_id', NEW.local_atual_id,
            'status', NEW.status,
            'observacoes', NEW.observacoes
        ),
        (SELECT id FROM usuario WHERE email = CURRENT_USER() LIMIT 1)
    );
END //

-- trg_auditoria_patrimonio_delete
CREATE TRIGGER trg_auditoria_patrimonio_delete
AFTER DELETE ON patrimonio
FOR EACH ROW
BEGIN
    INSERT INTO auditoria (tabela, registro_id, acao, antes_json, depois_json, usuario_id)
    VALUES (
        'patrimonio',
        OLD.id,
        'DELETE',
        JSON_OBJECT(
            'id', OLD.id,
            'codigo_tombamento', OLD.codigo_tombamento,
            'descricao', OLD.descricao,
            'categoria_id', OLD.categoria_id,
            'numero_serie', OLD.numero_serie,
            'data_aquisicao', OLD.data_aquisicao,
            'valor_aquisicao', OLD.valor_aquisicao,
            'nota_fiscal_item_id', OLD.nota_fiscal_item_id,
            'centro_custo_id', OLD.centro_custo_id,
            'setor_atual_id', OLD.setor_atual_id,
            'local_atual_id', OLD.local_atual_id,
            'status', OLD.status,
            'observacoes', OLD.observacoes
        ),
        NULL,
        (SELECT id FROM usuario WHERE email = CURRENT_USER() LIMIT 1)
    );
END //

-- trg_nf_item_valida_quantidade: Garante que a quantidade de um item de nota fiscal seja maior que zero.
CREATE TRIGGER trg_nf_item_valida_quantidade
BEFORE INSERT ON nota_fiscal_item
FOR EACH ROW
BEGIN
    IF NEW.quantidade <= 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'A quantidade do item da nota fiscal deve ser maior que zero.';
    END IF;
END //

DELIMITER ;




-- Tabela: depreciacao_param (se preferir, use apenas categoria, mas o prompt pediu esta)
CREATE TABLE depreciacao_param (
    id INT AUTO_INCREMENT PRIMARY KEY,
    categoria_id INT NOT NULL UNIQUE COMMENT 'ID da categoria para a qual estes parâmetros de depreciação se aplicam',
    vida_util_meses INT NOT NULL COMMENT 'Vida útil em meses para bens desta categoria',
    valor_residual_percent DECIMAL(5,2) NOT NULL COMMENT 'Percentual do valor residual para cálculo de depreciação (ex: 0.10 para 10%)',
    FOREIGN KEY (categoria_id) REFERENCES categoria(id) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;




-- EVENT (scheduler) para depreciação

DELIMITER //

-- Função para calcular o valor depreciável
CREATE FUNCTION fn_calcular_valor_depreciavel(
    p_valor_aquisicao DECIMAL(15,2),
    p_valor_residual_percent DECIMAL(5,2)
)
RETURNS DECIMAL(15,2)
READS SQL DATA
BEGIN
    RETURN p_valor_aquisicao - (p_valor_aquisicao * p_valor_residual_percent);
END //

-- Evento mensal para lançar depreciação
CREATE EVENT IF NOT EXISTS evt_depreciacao_mensal
ON SCHEDULE EVERY 1 MONTH
STARTS CONCAT(CURDATE() - INTERVAL DAYOFMONTH(CURDATE())-1 DAY, ' 00:00:00') -- Inicia no primeiro dia do mês atual
DO
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE v_patrimonio_id INT;
    DECLARE v_valor_aquisicao DECIMAL(15,2);
    DECLARE v_vida_util_meses INT;
    DECLARE v_valor_residual_percent DECIMAL(5,2);
    DECLARE v_valor_depreciavel DECIMAL(15,2);
    DECLARE v_valor_mensal DECIMAL(15,2);
    DECLARE v_acumulado_anterior DECIMAL(15,2);
    DECLARE v_competencia DATE;

    -- Cursor para patrimônios ativos com categoria que tem parâmetros de depreciação
    DECLARE cur_patrimonios CURSOR FOR
        SELECT
            p.id,
            p.valor_aquisicao,
            COALESCE(dp.vida_util_meses, c.vida_util_meses) AS vida_util_meses,
            COALESCE(dp.valor_residual_percent, c.valor_residual_percent) AS valor_residual_percent
        FROM
            patrimonio p
        JOIN
            categoria c ON p.categoria_id = c.id
        LEFT JOIN
            depreciacao_param dp ON p.categoria_id = dp.categoria_id
        WHERE
            p.status = 'ativo'
            AND (COALESCE(dp.vida_util_meses, c.vida_util_meses) IS NOT NULL
            AND COALESCE(dp.valor_residual_percent, c.valor_residual_percent) IS NOT NULL);

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    SET v_competencia = CURDATE() - INTERVAL DAYOFMONTH(CURDATE())-1 DAY; -- Primeiro dia do mês atual

    OPEN cur_patrimonios;

    read_loop: LOOP
        FETCH cur_patrimonios INTO v_patrimonio_id, v_valor_aquisicao, v_vida_util_meses, v_valor_residual_percent;

        IF done THEN
            LEAVE read_loop;
        END IF;

        -- Calcular valor depreciável e valor mensal
        SET v_valor_depreciavel = fn_calcular_valor_depreciavel(v_valor_aquisicao, v_valor_residual_percent);
        SET v_valor_mensal = v_valor_depreciavel / v_vida_util_meses;

        -- Obter depreciação acumulada anterior
        SELECT COALESCE(acumulado, 0)
        INTO v_acumulado_anterior
        FROM depreciacao_lancamento
        WHERE patrimonio_id = v_patrimonio_id
        ORDER BY competencia DESC
        LIMIT 1;

        -- Inserir lançamento de depreciação, se ainda não depreciou totalmente
        IF (v_acumulado_anterior + v_valor_mensal) <= v_valor_depreciavel THEN
            INSERT INTO depreciacao_lancamento (patrimonio_id, competencia, valor, acumulado)
            VALUES (v_patrimonio_id, v_competencia, v_valor_mensal, v_acumulado_anterior + v_valor_mensal);
        ELSEIF v_acumulado_anterior < v_valor_depreciavel THEN -- Lançar o restante para completar a depreciação
            INSERT INTO depreciacao_lancamento (patrimonio_id, competencia, valor, acumulado)
            VALUES (v_patrimonio_id, v_competencia, v_valor_depreciavel - v_acumulado_anterior, v_valor_depreciavel);
        END IF;

    END LOOP;

    CLOSE cur_patrimonios;
END //

DELIMITER ;




-- INSERTs de dados de exemplo

-- Papéis
INSERT INTO papel (nome) VALUES (
    'master'
);
INSERT INTO papel (nome) VALUES (
    'admin'
);
INSERT INTO papel (nome) VALUES (
    'operador'
);

-- Usuário master (senha: Exemplo123! - apenas para ambiente dev)
CALL sp_criar_usuario(
    'Master IDEAU',
    'master@ideau.edu.br',
    'Exemplo123!',
    'master'
);

-- Fornecedores
INSERT INTO fornecedor (razao_social, cnpj, ie, contato, telefone, email) VALUES (
    'Tech Suprimentos Ltda.',
    '00.111.222/0001-00',
    '123.456.789.000',
    'João Silva',
    '(11) 98765-4321',
    'contato@techsuprimentos.com.br'
);
INSERT INTO fornecedor (razao_social, cnpj, ie, contato, telefone, email) VALUES (
    'Mobiliário Conforto S.A.',
    '00.333.444/0001-00',
    '987.654.321.000',
    'Maria Oliveira',
    '(21) 99887-6655',
    'vendas@mobiliarioconforto.com.br'
);

-- Categorias
INSERT INTO categoria (nome, vida_util_meses, valor_residual_percent) VALUES (
    'Computadores',
    48,
    0.10
);
INSERT INTO categoria (nome, vida_util_meses, valor_residual_percent) VALUES (
    'Mobiliário',
    120,
    0.05
);

-- Setores
INSERT INTO setor (nome) VALUES (
    'Administração'
);
INSERT INTO setor (nome) VALUES (
    'Laboratório'
);

-- Locais
INSERT INTO local (setor_id, predio, sala, descricao) VALUES (
    (SELECT id FROM setor WHERE nome = 'Administração'),
    'Prédio Principal',
    'Sala 101',
    'Escritório da Direção'
);
INSERT INTO local (setor_id, predio, sala, descricao) VALUES (
    (SELECT id FROM setor WHERE nome = 'Laboratório'),
    'Prédio Anexo',
    'Lab Info 1',
    'Laboratório de Informática 1'
);

-- Centro de Custo
INSERT INTO centro_custo (codigo, nome) VALUES (
    'CC001',
    'Centro de Custo Geral'
);

-- Nota Fiscal
INSERT INTO nota_fiscal (numero, serie, chave_acesso, data_emissao, fornecedor_id, valor_total) VALUES (
    '000123',
    '1',
    '12345678901234567890123456789012345678901234',
    '2024-01-15',
    (SELECT id FROM fornecedor WHERE cnpj = '00.111.222/0001-00'),
    3500.00
);

-- Itens da Nota Fiscal
INSERT INTO nota_fiscal_item (nota_fiscal_id, descricao, quantidade, valor_unitario, ncm, cfop) VALUES (
    (SELECT id FROM nota_fiscal WHERE chave_acesso = '12345678901234567890123456789012345678901234'),
    'Computador Desktop Dell Optiplex',
    1,
    2500.00,
    '84715010',
    '5102'
);
INSERT INTO nota_fiscal_item (nota_fiscal_id, descricao, quantidade, valor_unitario, ncm, cfop) VALUES (
    (SELECT id FROM nota_fiscal WHERE chave_acesso = '12345678901234567890123456789012345678901234'),
    'Mesa de Escritório Ergonômica',
    1,
    1000.00,
    '94033000',
    '5102'
);

-- Patrimônios criados a partir dos itens da NF
CALL sp_registrar_patrimonio(
    'PATR001',
    'Computador Desktop Dell Optiplex, Intel i7, 16GB RAM, 512GB SSD',
    (SELECT id FROM categoria WHERE nome = 'Computadores'),
    'SN123456789',
    '2024-01-15',
    2500.00,
    (SELECT id FROM nota_fiscal_item WHERE descricao = 'Computador Desktop Dell Optiplex' AND nota_fiscal_id = (SELECT id FROM nota_fiscal WHERE chave_acesso = '12345678901234567890123456789012345678901234')),
    (SELECT id FROM centro_custo WHERE codigo = 'CC001'),
    (SELECT id FROM setor WHERE nome = 'Administração'),
    (SELECT id FROM local WHERE descricao = 'Escritório da Direção'),
    'ativo',
    'Computador para uso administrativo.'
);

CALL sp_registrar_patrimonio(
    'PATR002',
    'Mesa de Escritório Ergonômica com ajuste de altura',
    (SELECT id FROM categoria WHERE nome = 'Mobiliário'),
    'SN987654321',
    '2024-01-15',
    1000.00,
    (SELECT id FROM nota_fiscal_item WHERE descricao = 'Mesa de Escritório Ergonômica' AND nota_fiscal_id = (SELECT id FROM nota_fiscal WHERE chave_acesso = '12345678901234567890123456789012345678901234')),
    (SELECT id FROM centro_custo WHERE codigo = 'CC001'),
    (SELECT id FROM setor WHERE nome = 'Administração'),
    (SELECT id FROM local WHERE descricao = 'Escritório da Direção'),
    'ativo',
    'Mesa para estação de trabalho.'
);

-- Movimentação de um patrimônio (PATR001 para Laboratório)
CALL sp_transferir_patrimonio(
    (SELECT id FROM patrimonio WHERE codigo_tombamento = 'PATR001'),
    (SELECT id FROM setor WHERE nome = 'Laboratório'),
    (SELECT id FROM local WHERE descricao = 'Laboratório de Informática 1'),
    'Transferência para novo laboratório',
    (SELECT id FROM usuario WHERE email = 'master@ideau.edu.br')
);

-- Manutenção corretiva
INSERT INTO manutencao (patrimonio_id, tipo, descricao, custo, data_inicio, data_fim, empresa, nf_servico_id) VALUES (
    (SELECT id FROM patrimonio WHERE codigo_tombamento = 'PATR001'),
    'corretiva',
    'Troca de fonte de alimentação',
    150.00,
    '2024-03-10',
    '2024-03-12',
    'Manutenção Express Ltda.',
    NULL
);

-- Anexo Meta (apenas metadados)
INSERT INTO anexo_meta (entidade, entidade_id, nome_arquivo, caminho, tamanho_bytes, mime_type) VALUES (
    'patrimonio',
    (SELECT id FROM patrimonio WHERE codigo_tombamento = 'PATR001'),
    'foto_computador_patr001.jpg',
    '/uploads/patrimonio/PATR001/foto_computador_patr001.jpg',
    102400,
    'image/jpeg'
);




-- Consultas de teste (SELECTs)

-- 1. Buscar patrimônio por qualquer termo (codigo_tombamento, descrição, série, NF, fornecedor)
-- Exemplo: Buscar por 'Computador'
SELECT * FROM view_patrimonio_operador WHERE descricao LIKE 
    '%Computador%';

-- Exemplo: Buscar por código de tombamento 'PATR001'
SELECT * FROM view_patrimonio_operador WHERE codigo_tombamento = 
    'PATR001';

-- Exemplo: Buscar por número de série 'SN123456789'
SELECT * FROM view_patrimonio_operador WHERE numero_serie = 
    'SN123456789';

-- Exemplo: Buscar usando a PROCEDURE sp_busca_patrimonio
CALL sp_busca_patrimonio(
    p_termo_busca => 'Dell',
    p_categoria_id => NULL,
    p_nota_fiscal_id => NULL,
    p_setor_id => NULL,
    p_status => NULL,
    p_data_aquisicao_inicio => NULL,
    p_data_aquisicao_fim => NULL,
    p_fornecedor_id => NULL
);

-- 2. Listar bens por setor/local/status
-- Bens no setor 'Laboratório'
SELECT
    p.codigo_tombamento,
    p.descricao,
    s.nome AS setor,
    l.descricao AS local,
    p.status
FROM
    patrimonio p
JOIN
    setor s ON p.setor_atual_id = s.id
JOIN
    local l ON p.local_atual_id = l.id
WHERE
    s.nome = 'Laboratório';

-- Bens com status 'ativo'
SELECT
    codigo_tombamento,
    descricao,
    status
FROM
    patrimonio
WHERE
    status = 'ativo';

-- 3. Histórico de movimentações por patrimônio
-- Histórico do patrimônio 'PATR001'
SELECT
    m.criado_em AS data_movimentacao,
    p.codigo_tombamento,
    s_origem.nome AS setor_origem,
    l_origem.descricao AS local_origem,
    s_destino.nome AS setor_destino,
    l_destino.descricao AS local_destino,
    m.motivo,
    u.nome AS usuario_responsavel
FROM
    movimentacao m
JOIN
    patrimonio p ON m.patrimonio_id = p.id
LEFT JOIN
    setor s_origem ON m.de_setor_id = s_origem.id
LEFT JOIN
    local l_origem ON m.de_local_id = l_origem.id
JOIN
    setor s_destino ON m.para_setor_id = s_destino.id
JOIN
    local l_destino ON m.para_local_id = l_destino.id
JOIN
    usuario u ON m.usuario_id = u.id
WHERE
    p.codigo_tombamento = 'PATR001'
ORDER BY
    m.criado_em DESC;

-- 4. Manutenções e custo total por período
-- Todas as manutenções
SELECT
    m.data_inicio,
    p.codigo_tombamento,
    p.descricao AS patrimonio_descricao,
    m.tipo,
    m.descricao AS manutencao_descricao,
    m.custo,
    m.empresa
FROM
    manutencao m
JOIN
    patrimonio p ON m.patrimonio_id = p.id
ORDER BY
    m.data_inicio DESC;

-- Custo total de manutenções em 2024
SELECT
    SUM(custo) AS custo_total_manutencoes
FROM
    manutencao
WHERE
    YEAR(data_inicio) = 2024;

-- 5. Depreciação acumulada por patrimônio e por categoria
-- Depreciação acumulada por patrimônio
SELECT
    p.codigo_tombamento,
    p.descricao,
    SUM(dl.valor) AS depreciacao_acumulada
FROM
    depreciacao_lancamento dl
JOIN
    patrimonio p ON dl.patrimonio_id = p.id
GROUP BY
    p.id, p.codigo_tombamento, p.descricao
ORDER BY
    p.codigo_tombamento;

-- Depreciação acumulada por categoria
SELECT
    c.nome AS categoria,
    SUM(dl.valor) AS depreciacao_acumulada_categoria
FROM
    depreciacao_lancamento dl
JOIN
    patrimonio p ON dl.patrimonio_id = p.id
JOIN
    categoria c ON p.categoria_id = c.id
GROUP BY
    c.nome
ORDER BY
    c.nome;
